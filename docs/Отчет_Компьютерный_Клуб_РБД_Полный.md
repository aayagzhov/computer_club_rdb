# Федеральное государственное автономное образовательное учреждение высшего образования

## "Национальный исследовательский университет "Высшая школа экономики"

### Московский институт электроники и математики им. А. Н. Тихонова
### Департамент компьютерной инженерии

---

# Отчёт по дисциплине «Распределенные базы данных»

## «ПРОЕКТИРОВАНИЕ РАСПРЕДЕЛЕННОЙ БАЗЫ ДАННЫХ "Компьютерный клуб"»

**Студенты:**
- Воронов Арсений Игоревич
- Коленько Александр Сергеевич
- Ничик Станислав Александрович

**Группы:** МКС252, МКС254

**Преподаватель:** Чернышов Л.Н.

**Дата:** 16.12.2024 г.

**Оценка:** _____________

---

**Москва, 2024**

---

# СОДЕРЖАНИЕ

1. [Определение требований к системе БД «Распределенная БД компьютерного клуба»](#1-определение-требований)
   - 1.1 [Постановка задачи](#11-постановка-задачи)
   - 1.2 [Анализ информационных задач](#12-анализ-информационных-задач)
   - 1.3 [Роли и их зона ответственности](#13-роли-и-их-зона-ответственности)
   - 1.4 [Функциональные требования](#14-функциональные-требования)
   - 1.5 [Описание данных и структур таблиц](#15-описание-данных-и-структур-таблиц)

2. [Технический проект системы "Распределенная БД компьютерного клуба"](#2-технический-проект)
   - 2.1 [Архитектура системы](#21-архитектура-системы)
   - 2.2 [Схема БД](#22-схема-бд)
   - 2.3 [Триггеры и процедуры](#23-триггеры-и-процедуры)

3. [Рабочий проект системы "Распределенная БД компьютерного клуба"](#3-рабочий-проект)
   - 3.1 [Скрипт для создания базы данных](#31-скрипт-для-создания-базы-данных)
   - 3.2 [Данные в базе данных](#32-данные-в-базе-данных)
   - 3.3 [Представления](#33-представления)
   - 3.4 [Реализация репликации](#34-реализация-репликации)
   - 3.5 [Модули (компоненты) системы](#35-модули-компоненты-системы)
   - 3.6 [Безопасность, доступ и разграничение прав](#36-безопасность-доступ-и-разграничение-прав)
   - 3.7 [Описание тестового сценария](#37-описание-тестового-сценария)

4. [ЗАКЛЮЧЕНИЕ](#заключение)

5. [СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ](#список-использованных-источников)

6. [ПРИЛОЖЕНИЯ](#приложения)

---

# 1. Определение требований к системе БД «Распределенная БД компьютерного клуба»

## 1.1 Постановка задачи

Требуется спроектировать и реализовать распределенную реляционную базу данных для сети компьютерных клубов с разделением на четыре узла: **Центральный офис** и три **Клуба** (Клуб 1, Клуб 2, Клуб 3). Система должна поддерживать полный жизненный цикл работы компьютерного клуба: управление игровыми местами, бронирование, проведение игровых сессий, обслуживание оборудования и управление персоналом.

### Ключевые цели проекта:

1. **Локальная доступность данных** - каждый клуб должен иметь возможность работать автономно при временных сетевых сбоях
2. **Двунаправленная репликация** - использование комбинации:
   - Master-Slave репликации (Центр → Клубы) для справочных данных (НСИ)
   - Master-Master репликации для таблицы клиентов
   - Фильтрованная репликация заявок на обслуживание по клубам
3. **Строгий контроль прав** - разграничение доступа по ролям и статусам
4. **Масштабируемость** - возможность добавления новых клубов без изменения схемы
5. **Аудит изменений** - фиксация всех значимых операций в журналах

### Схема узлов компьютерной сети

Система состоит из четырех узлов PostgreSQL 16:
- **central_db** (порт 5432) - центральный офис
- **club1_db** (порт 5433) - клуб 1
- **club2_db** (порт 5434) - клуб 2  
- **club3_db** (порт 5435) - клуб 3

Все узлы объединены в Docker-сеть `club_net` и используют расширение **Spock** для логической репликации.

### Состав реализуемого подмножества

В систему включены следующие основные сущности:

**Справочные данные (НСИ):**
- Клубы (`clubs`)
- Тарифы (`tariffs`)
- Конфигурации оборудования (`configurations`)
- Статусы игровых мест (`gaming_seat_statuses`)
- Статусы заявок на обслуживание (`maintenance_request_status`)
- Статусы бронирований (`booking_statuses`)
- Статусы скидок (`discount_statuses`)
- Должности (`job_titles`)

**Основные транзакционные таблицы:**
- Сотрудники (`employees`)
- Клиенты (`clients`) - с master-master репликацией
- Игровые места (`gaming_seats`)
- Бронирования (`bookings`)
- Игровые сессии (`sessions`)
- Смены сотрудников (`shift`)
- Заявки на обслуживание (`maintenance_requests`) - с фильтрованной репликацией

**Служебные таблицы:**
- Журнал конфликтов (`conflict_log`)

## 1.2 Анализ информационных задач

К основным информационным задачам разрабатываемой распределённой системы относятся:

### 1. Управление справочными данными (НСИ)

Система должна обеспечивать централизованное управление справочной информацией на узле Центра с последующей репликацией на все клубы. Это включает:
- Ведение каталога клубов и их характеристик
- Управление тарифами и конфигурациями оборудования
- Поддержку справочников статусов и должностей
- Управление данными о сотрудниках

Актуальное состояние НСИ формируется на центральном узле и в режиме master-slave репликации передаётся на периферийные узлы.

### 2. Управление клиентской базой

Информационная подсистема должна поддерживать:
- Регистрацию новых клиентов на любом узле
- Синхронизацию клиентской базы между всеми узлами (master-master репликация)
- Управление программой лояльности (статусы скидок)
- Аутентификацию клиентов на любом узле сети

### 3. Управление игровыми местами и бронированиями

Каждый клуб должен иметь возможность:
- Управлять статусами своих игровых мест
- Создавать и отменять бронирования
- Контролировать пересечения бронирований (constraint `bookings_no_overlap`)
- Проводить игровые сессии
- Автоматически блокировать бронирования при поломке оборудования

### 4. Система обслуживания оборудования

Система должна обеспечивать:
- Создание заявок на обслуживание в клубах
- Передачу заявок в центральный офис для назначения исполнителя
- Блокировку редактирования заявок в клубах после отправки в центр
- Автоматический перевод оборудования в статус "На обслуживании"
- Автоматическую отмену будущих бронирований при поломке
- Возврат оборудования в работу после завершения ремонта

### 5. Фильтрованная репликация заявок

Центральный узел должен реплицировать заявки на обслуживание обратно в клубы с фильтрацией по `club_id`, чтобы каждый клуб видел только свои заявки.

### 6. Управление персоналом и сменами

Система должна поддерживать:
- Учёт сотрудников с привязкой к клубам
- Управление сменами
- Разграничение прав доступа по должностям

### 7. Мониторинг и аудит

Администраторы системы должны иметь доступ к:
- Мониторингу состояния репликации
- Журналу конфликтов репликации
- Инструментам ручного разрешения конфликтов
- Проверке целостности данных

## 1.3 Роли и их зона ответственности

### Администратор клуба

**Роль:** Сотрудник клуба, отвечающий за обслуживание клиентов и управление бронированиями.

**Основные обязанности:**
- Регистрация новых клиентов
- Создание и управление бронированиями
- Проведение игровых сессий
- Создание заявок на обслуживание оборудования
- Просмотр информации о своём клубе

**Ограничения:**
- Не может редактировать заявки после отправки в центр (статус "Создана")
- Не может создавать бронирования на неисправное оборудование
- Видит только данные своего клуба

### Технический специалист

**Роль:** Сотрудник, отвечающий за техническое обслуживание оборудования.

**Основные обязанности:**
- Создание заявок на обслуживание
- Выполнение ремонтных работ (после назначения из центра)
- Обновление статусов заявок
- Управление статусами игровых мест

**Ограничения:**
- Не может редактировать заявки в статусе "Создана"
- Работает только с заявками своего клуба

### Менеджер центрального офиса

**Роль:** Сотрудник центрального офиса, управляющий операциями сети клубов.

**Основные обязанности:**
- Просмотр всех заявок на обслуживание
- Назначение исполнителей на заявки
- Изменение статусов заявок
- Управление справочными данными (НСИ)
- Мониторинг работы всех клубов

**Ограничения:**
- Не может напрямую управлять бронированиями в клубах

### Директор

**Роль:** Руководитель сети компьютерных клубов.

**Основные обязанности:**
- Полный доступ ко всем данным системы
- Управление персоналом
- Управление тарифами и конфигурациями
- Принятие стратегических решений
- Доступ к аналитическим отчётам

**Ограничения:**
- Нет технических ограничений

### Администратор БД

**Роль:** Технический персонал, обеспечивающий функционирование распределённой БД.

**Основные обязанности:**
- Развёртывание и обслуживание узлов БД
- Управление репликацией (публикации и подписки)
- Конфигурирование прав доступа
- Мониторинг состояния репликации
- Разрешение конфликтов репликации
- Выполнение резервного копирования
- Миграции схемы БД

**Ограничения:**
- Нет прямого участия в бизнес-процессах

### Таблица прав доступа

| Таблица | Администратор клуба | Технический специалист | Менеджер центра | Директор | Администратор БД |
|---------|---------------------|------------------------|-----------------|----------|------------------|
| clients | SI | S | SUID | SUID | SUID |
| bookings | SUID (свой клуб) | S | S | SUID | SUID |
| sessions | SUID (свой клуб) | S | S | SUID | SUID |
| gaming_seats | SU (свой клуб) | SU (свой клуб) | S | SUID | SUID |
| maintenance_requests | SI (свой клуб) | SIU (свой клуб) | SUID | SUID | SUID |
| employees | S | S | SUID | SUID | SUID |
| shift | SUID (свой клуб) | S | S | SUID | SUID |
| НСИ (все справочники) | S | S | SUID | SUID | SUID |
| conflict_log | - | - | S | SUID | SUID |

**Обозначения:** S - SELECT, I - INSERT, U - UPDATE, D - DELETE

## 1.4 Функциональные требования

### USE-CASE диаграмма

**Администратор клуба:**
- Регистрация клиента
- Создание бронирования
- Отмена бронирования
- Начало игровой сессии
- Завершение игровой сессии
- Создание заявки на обслуживание
- Просмотр статуса заявок

**Технический специалист:**
- Создание заявки на обслуживание
- Выполнение ремонта
- Обновление статуса заявки
- Перевод оборудования в статус "На обслуживании"
- Возврат оборудования в работу

**Менеджер центра:**
- Просмотр всех заявок
- Назначение исполнителя на заявку
- Изменение статуса заявки
- Управление НСИ
- Просмотр отчётов

**Директор:**
- Все функции менеджера
- Управление персоналом
- Управление тарифами
- Управление клубами
- Просмотр аналитики

**Администратор БД:**
- Мониторинг репликации
- Разрешение конфликтов
- Управление подписками
- Резервное копирование
- Миграции схемы

## 1.5 Описание данных и структур таблиц

### Таблица 1 - Клубы (clubs)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | serial | 4 | PRIMARY KEY |
| address | text | var | NOT NULL, адрес клуба |
| phone_number | char | 11 | NOT NULL, телефон |
| seat_count | smallint | 2 | NOT NULL, количество мест |

### Таблица 2 - Тарифы (tariffs)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| name | text | var | NOT NULL, название тарифа |
| price | smallint | 2 | NOT NULL, цена за час |
| description | text | var | NOT NULL, описание |

### Таблица 3 - Конфигурации (configurations)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | serial | 4 | PRIMARY KEY |
| tariff_id | smallint | 2 | NOT NULL, FK → tariffs(id) |
| cpu | text | var | NOT NULL, процессор |
| gpu | text | var | NOT NULL, видеокарта |
| ram | text | var | NOT NULL, оперативная память |
| storage | text | var | NOT NULL, накопитель |
| display | text | var | NOT NULL, монитор |
| mouse | text | var | NOT NULL, мышь |
| keyboard | text | var | NOT NULL, клавиатура |
| headset | text | var | NOT NULL, наушники |
| os | text | var | NOT NULL, операционная система |

### Таблица 4 - Статусы игровых мест (gaming_seat_statuses)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| status | varchar | 20 | NOT NULL, название статуса |

**Значения:**
1. Доступно
2. Занято
3. На обслуживании
4. Не эксплуатируется

### Таблица 5 - Статусы заявок (maintenance_request_status)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| status | varchar | 20 | NOT NULL, название статуса |

**Значения:**
1. Создана
2. В работе
3. Завершено
4. Отменено

### Таблица 6 - Статусы бронирований (booking_statuses)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| status | varchar | 20 | NOT NULL, название статуса |

**Значения:**
1. Активно
2. Завершено
3. Отменено

### Таблица 7 - Статусы скидок (discount_statuses)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| discount_percentage | smallint | 2 | NOT NULL, процент скидки |

**Значения:** 0%, 5%, 10%, 15%, 20%

### Таблица 8 - Должности (job_titles)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | smallserial | 2 | PRIMARY KEY |
| title | text | var | NOT NULL, название должности |
| description | text | var | NOT NULL, описание |
| access_rights | text | var | NOT NULL, права доступа |

### Таблица 9 - Сотрудники (employees)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | serial | 4 | PRIMARY KEY |
| job_title_id | smallint | 2 | NOT NULL, FK → job_titles(id) |
| club_id | smallint | 2 | NOT NULL, FK → clubs(id) |
| name | text | var | NOT NULL, имя |
| last_name | text | var | NOT NULL, фамилия |
| patronymic | text | var | NULL, отчество |
| passport_data | json | var | NOT NULL, паспортные данные |
| hire_date | date | 10 | NOT NULL, дата приёма |
| fire_date | date | 10 | NULL, дата увольнения |
| salary | integer | 4 | NOT NULL, зарплата в месяц |
| login | varchar | 30 | NOT NULL UNIQUE, логин |
| password_hash | char | 60 | NOT NULL, bcrypt hash |

### Таблица 10 - Клиенты (clients)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| phone_number | char | 11 | PRIMARY KEY, телефон |
| discount_status | smallint | 2 | NOT NULL, FK → discount_statuses(id) |
| password_hash | char | 60 | NOT NULL, bcrypt hash |
| registration_timestamp | timestamp | 19 | NOT NULL, дата регистрации |

**Особенность:** Таблица реплицируется в режиме master-master между всеми узлами.

### Таблица 11 - Игровые места (gaming_seats)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | integer | 4 | PRIMARY KEY |
| club_id | smallint | 2 | NOT NULL, FK → clubs(id) |
| configuration_id | integer | 4 | NOT NULL, FK → configurations(id) |
| status_id | smallint | 2 | NOT NULL, FK → gaming_seat_statuses(id) |

### Таблица 12 - Бронирования (bookings)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | integer | 4 | PRIMARY KEY |
| issuer_id | integer | 4 | NOT NULL, FK → employees(id) |
| status_id | smallint | 2 | NOT NULL, FK → booking_statuses(id) |
| gaming_seat_id | integer | 4 | NOT NULL, FK → gaming_seats(id) |
| client_phone_number | char | 11 | NOT NULL, FK → clients(phone_number) |
| creation_timestamp | timestamp | 19 | NOT NULL, время создания |
| start_timestamp | timestamp | 19 | NOT NULL, начало брони |
| end_timestamp | timestamp | 19 | NOT NULL, конец брони |

**Constraint:** `bookings_no_overlap` - исключает пересечение бронирований для одного игрового места.

### Таблица 13 - Игровые сессии (sessions)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | integer | 4 | PRIMARY KEY |
| gaming_seat_id | integer | 4 | NOT NULL, FK → gaming_seats(id) |
| client_phone_number | char | 11 | NOT NULL, FK → clients(phone_number) |
| start_timestamp | timestamp | 19 | NOT NULL, начало сессии |
| end_timestamp | timestamp | 19 | NOT NULL, конец сессии |
| booking_id | integer | 4 | NULL, FK → bookings(id) |

### Таблица 14 - Смены (shift)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | integer | 4 | PRIMARY KEY |
| start_timestamp | timestamp | 19 | NOT NULL, начало смены |
| end_timestamp | timestamp | 19 | NOT NULL, конец смены |
| employee_id | integer | 4 | NOT NULL, FK → employees(id) |

### Таблица 15 - Заявки на обслуживание (maintenance_requests)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | integer | 4 | PRIMARY KEY |
| creation_timestamp | timestamp | 19 | NOT NULL, время создания |
| gaming_seat_id | integer | 4 | NULL, FK → gaming_seats(id) |
| club_id | smallint | 2 | NOT NULL, FK → clubs(id) |
| status | smallint | 2 | NOT NULL, FK → maintenance_request_status(id) |
| description | text | var | NOT NULL, описание проблемы |
| executor_id | integer | 4 | NULL, FK → employees(id) |
| issuer_id | integer | 4 | NOT NULL, FK → employees(id) |
| last_modified | timestamp | 19 | NOT NULL DEFAULT now() |

**Особенность:** Реплицируется с фильтрацией по `club_id` - каждый клуб получает только свои заявки.

**REPLICA IDENTITY:** FULL - для корректной работы репликации с фильтрами.

### Таблица 16 - Журнал конфликтов (conflict_log)

| Поле | Тип | Длина | Примечание |
|------|-----|-------|------------|
| id | serial | 4 | PRIMARY KEY |
| conflict_time | timestamp | 19 | NOT NULL DEFAULT now() |
| table_name | text | var | NOT NULL, имя таблицы |
| conflict_type | text | var | NOT NULL, тип конфликта |
| local_data | jsonb | var | NULL, локальные данные |
| remote_data | jsonb | var | NULL, удалённые данные |
| resolution | text | var | NULL, способ разрешения |
| resolved_by | text | var | NULL, кто разрешил |
| resolved_at | timestamp | 19 | NULL, время разрешения |

---

# 2. Технический проект системы "Распределенная БД компьютерного клуба"

## 2.1 Архитектура системы

Система развёрнута в виде четырёх контейнеров PostgreSQL 16 с использованием Docker Compose:

### Узлы системы

1. **central_db** (порт 5432) - центральный офис
   - Роль: Master для НСИ, Master для clients, Master для maintenance_requests
   - Функции: управление справочниками, назначение исполнителей, аналитика

2. **club1_db** (порт 5433) - клуб 1
   - Роль: Slave для НСИ, Master для clients, Master для своих maintenance_requests
   - Функции: обслуживание клиентов, бронирования, сессии

3. **club2_db** (порт 5434) - клуб 2
   - Роль: Slave для НСИ, Master для clients, Master для своих maintenance_requests
   - Функции: обслуживание клиентов, бронирования, сессии

4. **club3_db** (порт 5435) - клуб 3
   - Роль: Slave для НСИ, Master для clients, Master для своих maintenance_requests
   - Функции: обслуживание клиентов, бронирования, сессии

### Типы репликации

#### 1. Master-Slave репликация (НСИ)

**Направление:** Центр → Все клубы

**Таблицы:**
- clubs
- employees
- tariffs
- configurations
- gaming_seat_statuses
- maintenance_request_status
- booking_statuses
- discount_statuses
- job_titles

**Реализация:** PostgreSQL native logical replication (publication/subscription)

**Публикация на центре:**
```sql
CREATE PUBLICATION cental_club_nsi
FOR TABLE clubs, employees, tariffs, configurations,
          gaming_seat_statuses, maintenance_request_status,
          booking_statuses, discount_statuses, job_titles;
```

**Подписка на клубах:**
```sql
CREATE SUBSCRIPTION sub_from_central_to_club1_master_slace
  CONNECTION 'host=central_db port=5432 dbname=computer_club_rdb user=admin password=password'
  PUBLICATION cental_club_nsi
WITH (copy_data = true, create_slot = true);
```

#### 2. Master-Master репликация (clients)

**Направление:** Все узлы ↔ Все узлы

**Таблица:** clients

**Реализация:** Spock extension (multi-master replication)

**На каждом узле создаётся:**
- Spock node
- Replication set для clients
- Подписки на все остальные узлы

**Пример для центра:**
```sql
SELECT spock.node_create(
    node_name := 'central',
    dsn := 'host=central_db port=5432 dbname=computer_club_rdb user=admin password=password'
);

SELECT spock.repset_create(
    set_name := 'central_master_master',
    replicate_insert := true,
    replicate_update := true,
    replicate_delete := true,
    replicate_truncate := true
);

SELECT spock.repset_add_table(
    set_name := 'central_master_master',
    relation := 'public.clients',
    synchronize_data := false
);
```

**Подписки на клубах:**
```sql
SELECT spock.sub_create(
    subscription_name := 'sub_from_central_to_club1_master_master',
    provider_dsn := 'host=central_db port=5432 user=admin password=password dbname=computer_club_rdb',
    replication_sets := ARRAY['central_master_master'],
    synchronize_structure := false,
    synchronize_data := false,
    forward_origins := ARRAY[]::text[]
);
```

#### 3. Фильтрованная репликация (maintenance_requests)

**Направление:** Центр ↔ Клубы (с фильтрацией)

**Таблица:** maintenance_requests

**Реализация:** Spock с row-filter

**На центре создаются отдельные replication sets для каарий:**
1. На клубе 1: `INSERT INTO maintenance_requests (id, creation_timestamp, gaming_seat_id, club_id, status, description, issuer_id, last_modified) VALUES (1000001, NOW(), 101, 1, 1, 'Не работает мышь', 11, NOW())`
2. На клубе 2: `INSERT INTO maintenance_requests (id, creation_timestamp, gaming_seat_id, club_id, status, description, issuer_id, last_modified) VALUES (2000001, NOW(), 201, 2, 1, 'Зависает компьютер', 14, NOW())`
3. Подождать 5 секунд

**Ожидаемый результат:** 
- Клуб 1 видит только заявку с club_id=1
- Клуб 2 видит только заявку с club_id=2
- Центр видит обе заявки

**Проверка:**
```sql
-- На клубе 1
SELECT COUNT(*) FROM maintenance_requests WHERE club_id = 1; -- Должно быть 1
SELECT COUNT(*) FROM maintenance_requests WHERE club_id = 2; -- Должно быть 0

-- На центре
SELECT COUNT(*) FROM maintenance_requests; -- Должно быть 2
```

### Тест 4: Проверка триггера блокировки редактирования

**Цель:** Проверить, что заявки в статусе "Создана" нельзя редактировать в клубах.

**Сценарий:**
1. На клубе 1 создать заявку: `INSERT INTO maintenance_requests (...) VALUES (..., status=1, ...)`
2. Попытаться изменить на клубе 1: `UPDATE maintenance_requests SET description = 'Новое описание' WHERE id = 1000001`

**Ожидаемый результат:** Ошибка "Невозможно редактировать заявку со статусом 'Создана'"

**Проверка:**
```sql
-- Должна возникнуть ошибка
UPDATE maintenance_requests SET description = 'test' WHERE id = 1000001 AND status = 1;
```

### Тест 5: Проверка автоматического управления статусами

**Цель:** Проверить, что при создании заявки ПК автоматически переводится в статус "На обслуживании", а бронирования отменяются.

**Сценарий:**
1. Создать бронирование на будущее для игрового места 101
2. Создать заявку на обслуживание для места 101
3. Проверить статус места и бронирования

**Ожидаемый результат:**
- Статус места изменился на 3 (На обслуживании)
- Бронирование отменено (status_id = 3)

**Проверка:**
```sql
SELECT status_id FROM gaming_seats WHERE id = 101; -- Должно быть 3
SELECT status_id FROM bookings WHERE gaming_seat_id = 101; -- Должно быть 3
```

### Тест 6: Проверка возврата ПК в работу

**Цель:** Проверить, что при завершении заявки ПК возвращается в статус "Доступно".

**Сценарий:**
1. На центре изменить статус заявки: `UPDATE maintenance_requests SET status = 3 WHERE id = 1000001`
2. Подождать репликации
3. Проверить статус игрового места

**Ожидаемый результат:** Статус места изменился на 1 (Доступно)

**Проверка:**
```sql
SELECT status_id FROM gaming_seats WHERE id = 101; -- Должно быть 1
```

### Результаты тестирования

Все тесты выполняются автоматически с помощью скриптов в директории `tests/`. Результаты сохраняются в таблице `test_results.test_log`.

**Просмотр результатов:**
```sql
SELECT test_suite, test_name, status, message, executed_at
FROM test_results.test_log
ORDER BY executed_at DESC;
```

**Статистика тестов:**
```sql
SELECT 
    test_suite,
    COUNT(*) as total_tests,
    SUM(CASE WHEN status = 'PASS' THEN 1 ELSE 0 END) as passed,
    SUM(CASE WHEN status = 'FAIL' THEN 1 ELSE 0 END) as failed,
    SUM(CASE WHEN status = 'WARN' THEN 1 ELSE 0 END) as warnings
FROM test_results.test_log
GROUP BY test_suite;
```

---

# ЗАКЛЮЧЕНИЕ

В рамках данного проекта была разработана и реализована распределённая база данных для сети компьютерных клубов с чётким разделением зон ответственности между центральным офисом и филиалами.

## Достигнутые результаты:

1. **Гибридная архитектура репликации** - успешно реализована комбинация трёх типов репликации:
   - Master-Slave для справочных данных (НСИ)
   - Master-Master для клиентской базы
   - Фильтрованная репликация для заявок на обслуживание

2. **Автоматизация бизнес-процессов** - реализовано 6 триггеров, обеспечивающих:
   - Автоматическое управление статусами оборудования
   - Блокировку некорректных операций
   - Отмену бронирований при поломках
   - Контроль прав редактирования

3. **Локальная доступность данных** - каждый клуб может работать автономно при временных сетевых сбоях, имея локальные копии необходимых данных

4. **Масштабируемость** - архитектура позволяет добавлять новые клубы без изменения схемы БД, только путём создания новых узлов и настройки репликации

5. **Безопасность и аудит** - реализовано разграничение прав доступа по ролям и журналирование всех критичных операций

## Технологический стек:

- **СУБД:** PostgreSQL 16
- **Репликация:** Native PostgreSQL Logical Replication + Spock extension
- **Контейнеризация:** Docker Compose
- **Автоматизация:** Bash-скрипты для развёртывания и тестирования

## Особенности реализации:

- Использование разных диапазонов sequences для избежания конфликтов ID
- REPLICA IDENTITY FULL для корректной работы фильтрованной репликации
- Constraint `bookings_no_overlap` с GiST индексом для предотвращения пересечений бронирований
- Комплексная система тестирования с автоматическим логированием результатов

## Перспективы развития:

1. Добавление аналитических представлений и отчётов
2. Реализация автоматического разрешения конфликтов репликации
3. Интеграция с внешними системами (платёжные шлюзы, CRM)
4. Разработка веб-интерфейса для управления системой
5. Реализация мобильного приложения для клиентов

Разработанная система полностью соответствует поставленным требованиям и готова к промышленной эксплуатации.

---

# СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ

1. PostgreSQL Global Development Group. PostgreSQL Documentation: Logical Replication. – PostgreSQL 16 Manual. – 2024. – URL: https://www.postgresql.org/docs/16/logical-replication.html

2. Spock Extension Documentation. Multi-Master Replication for PostgreSQL. – 2024. – URL: https://github.com/pgEdge/spock

3. Stonebraker M., Özsu M.T. Principles of Distributed Database Systems. – 4th ed. – Springer, 2020. – 685 c.

4. Docker Inc. Docker Compose Documentation. – 2024. – URL: https://docs.docker.com/compose/

5. PostgreSQL Global Development Group. PostgreSQL Documentation: Triggers. – PostgreSQL 16 Manual. – 2024. – URL: https://www.postgresql.org/docs/16/triggers.html

6. Fowler M. Patterns of Enterprise Application Architecture. – Addison-Wesley Professional, 2022. – 560 с.

7. ISO/IEC 9075-1:2023. Information technology – Database languages – SQL – Part 1: Framework. – Geneva: ISO, 2023.

---

# ПРИЛОЖЕНИЯ

## ПРИЛОЖЕНИЕ А - Скрипт инициализации системы

```bash
#!/bin/bash

CONTAINERS="central_db club1_db club2_db club3_db"

echo "============================================"
echo " Init data bases"
echo "============================================"

echo "============================================"
echo " STAGE 1: Creating schema and Spock nodes"
echo "============================================"

for C in $CONTAINERS; do
    echo "=== Setting up $C ==="
    docker exec $C bash -c "psql -U pgedge -d postgres -f /general/1_init.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /general/2_shema.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /general/3_triggers.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/1_sequences.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/2_publications.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/3_create_spok_node.sql"
done

echo ""
echo "=== Waiting for all nodes to be ready (10 seconds) ==="
sleep 10

echo ""
echo "============================================"
echo " STAGE 2: Creating subscriptions"
echo "============================================"

for C in $CONTAINERS; do
    echo "=== Creating subscriptions on $C ==="
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/4_create_subscriptions.sql"
done

echo ""
echo "============================================"
echo " Master-Master replication setup complete!"
echo "============================================"
```

## ПРИЛОЖЕНИЕ Б - Docker Compose конфигурация

```yaml
version: '3.8'

services:
  central_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: central_db
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - central_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/central/settings:/settings
      - ./distributed_db/central/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club1_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club1_db
    restart: unless-stopped
    ports:
      - "5433:5432"
    volumes:
      - club1_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_1/settings:/settings
      - ./distributed_db/club_1/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club2_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club2_db
    restart: unless-stopped
    ports:
      - "5434:5432"
    volumes:
      - club2_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_2/settings:/settings
      - ./distributed_db/club_2/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club3_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club3_db
    restart: unless-stopped
    ports:
      - "5435:5432"
    volumes:
      - club3_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_3/settings:/settings
      - ./distributed_db/club_3/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

volumes:
  central_data:
  club1_data:
  club2_data:
  club3_data:

networks:
  club_net:
    driver: bridge
```

## ПРИЛОЖЕНИЕ В - Пример тестового сценария

```sql
-- Тест master-master репликации для таблицы clients

-- На центре
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79991111111', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 1
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79992222222', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 2
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79993333333', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 3
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79994444444', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- Проверка на каждом узле (должно быть 4 записи)
SELECT * FROM clients ORDER BY phone_number;
```

## ПРИЛОЖЕНИЕ Г - Журнал работ

| Этап работы | Дедлайн | Вес | Коленько | Ничик | Воронов |
|-------------|---------|-----|----------|-------|---------|
| Презентация | 16.12.2024 | 16 | 9 | 9 | 9 |
| Постановка задачи | 16.12.2024 | 18 | 9 | 9 | 9 |
| Определение структуры БД | 16.12.2024 | 27 | 10 | 9 | 8 |
| Загрузка данных | 16.12.2024 | 18 | 6 | 6 | 6 |
| Триггеры и процедуры | 16.12.2024 | 30 | 10 | 10 | 10 |
| Реализация репликации | 16.12.2024 | 30 | 10 | 10 | 10 |
| Тестирование | 16.12.2024 | 27 | 9 | 9 | 9 |
| Отчет | 16.12.2024 | 27 | 9 | 9 | 9 |
| **Итого** | | **193** | **72** | **71** | **70** |

---

**Конец документа**
арий:**
1. На клубе 1: `INSERT INTO maintenance_requests (id, creation_timestamp, gaming_seat_id, club_id, status, description, issuer_id, last_modified) VALUES (1000001, NOW(), 101, 1, 1, 'Не работает мышь', 11, NOW())`
2. На клубе 2: `INSERT INTO maintenance_requests (id, creation_timestamp, gaming_seat_id, club_id, status, description, issuer_id, last_modified) VALUES (2000001, NOW(), 201, 2, 1, 'Зависает компьютер', 14, NOW())`
3. Подождать 5 секунд

**Ожидаемый результат:** 
- Клуб 1 видит только заявку с club_id=1
- Клуб 2 видит только заявку с club_id=2
- Центр видит обе заявки

**Проверка:**
```sql
-- На клубе 1
SELECT COUNT(*) FROM maintenance_requests WHERE club_id = 1; -- Должно быть 1
SELECT COUNT(*) FROM maintenance_requests WHERE club_id = 2; -- Должно быть 0

-- На центре
SELECT COUNT(*) FROM maintenance_requests; -- Должно быть 2
```

### Тест 4: Проверка триггера блокировки редактирования

**Цель:** Проверить, что заявки в статусе "Создана" нельзя редактировать в клубах.

**Сценарий:**
1. На клубе 1 создать заявку: `INSERT INTO maintenance_requests (...) VALUES (..., status=1, ...)`
2. Попытаться изменить на клубе 1: `UPDATE maintenance_requests SET description = 'Новое описание' WHERE id = 1000001`

**Ожидаемый результат:** Ошибка "Невозможно редактировать заявку со статусом 'Создана'"

**Проверка:**
```sql
-- Должна возникнуть ошибка
UPDATE maintenance_requests SET description = 'test' WHERE id = 1000001 AND status = 1;
```

### Тест 5: Проверка автоматического управления статусами

**Цель:** Проверить, что при создании заявки ПК автоматически переводится в статус "На обслуживании", а бронирования отменяются.

**Сценарий:**
1. Создать бронирование на будущее для игрового места 101
2. Создать заявку на обслуживание для места 101
3. Проверить статус места и бронирования

**Ожидаемый результат:**
- Статус места изменился на 3 (На обслуживании)
- Бронирование отменено (status_id = 3)

**Проверка:**
```sql
SELECT status_id FROM gaming_seats WHERE id = 101; -- Должно быть 3
SELECT status_id FROM bookings WHERE gaming_seat_id = 101; -- Должно быть 3
```

### Тест 6: Проверка возврата ПК в работу

**Цель:** Проверить, что при завершении заявки ПК возвращается в статус "Доступно".

**Сценарий:**
1. На центре изменить статус заявки: `UPDATE maintenance_requests SET status = 3 WHERE id = 1000001`
2. Подождать репликации
3. Проверить статус игрового места

**Ожидаемый результат:** Статус места изменился на 1 (Доступно)

**Проверка:**
```sql
SELECT status_id FROM gaming_seats WHERE id = 101; -- Должно быть 1
```

### Результаты тестирования

Все тесты выполняются автоматически с помощью скриптов в директории `tests/`. Результаты сохраняются в таблице `test_results.test_log`.

**Просмотр результатов:**
```sql
SELECT test_suite, test_name, status, message, executed_at
FROM test_results.test_log
ORDER BY executed_at DESC;
```

**Статистика тестов:**
```sql
SELECT 
    test_suite,
    COUNT(*) as total_tests,
    SUM(CASE WHEN status = 'PASS' THEN 1 ELSE 0 END) as passed,
    SUM(CASE WHEN status = 'FAIL' THEN 1 ELSE 0 END) as failed,
    SUM(CASE WHEN status = 'WARN' THEN 1 ELSE 0 END) as warnings
FROM test_results.test_log
GROUP BY test_suite;
```

---

# ЗАКЛЮЧЕНИЕ

В рамках данного проекта была разработана и реализована распределённая база данных для сети компьютерных клубов с чётким разделением зон ответственности между центральным офисом и филиалами.

## Достигнутые результаты:

1. **Гибридная архитектура репликации** - успешно реализована комбинация трёх типов репликации:
   - Master-Slave для справочных данных (НСИ)
   - Master-Master для клиентской базы
   - Фильтрованная репликация для заявок на обслуживание

2. **Автоматизация бизнес-процессов** - реализовано 6 триггеров, обеспечивающих:
   - Автоматическое управление статусами оборудования
   - Блокировку некорректных операций
   - Отмену бронирований при поломках
   - Контроль прав редактирования

3. **Локальная доступность данных** - каждый клуб может работать автономно при временных сетевых сбоях, имея локальные копии необходимых данных

4. **Масштабируемость** - архитектура позволяет добавлять новые клубы без изменения схемы БД, только путём создания новых узлов и настройки репликации

5. **Безопасность и аудит** - реализовано разграничение прав доступа по ролям и журналирование всех критичных операций

## Технологический стек:

- **СУБД:** PostgreSQL 16
- **Репликация:** Native PostgreSQL Logical Replication + Spock extension
- **Контейнеризация:** Docker Compose
- **Автоматизация:** Bash-скрипты для развёртывания и тестирования

## Особенности реализации:

- Использование разных диапазонов sequences для избежания конфликтов ID
- REPLICA IDENTITY FULL для корректной работы фильтрованной репликации
- Constraint `bookings_no_overlap` с GiST индексом для предотвращения пересечений бронирований
- Комплексная система тестирования с автоматическим логированием результатов

## Перспективы развития:

1. Добавление аналитических представлений и отчётов
2. Реализация автоматического разрешения конфликтов репликации
3. Интеграция с внешними системами (платёжные шлюзы, CRM)
4. Разработка веб-интерфейса для управления системой
5. Реализация мобильного приложения для клиентов

Разработанная система полностью соответствует поставленным требованиям и готова к промышленной эксплуатации.

---

# СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ

1. PostgreSQL Global Development Group. PostgreSQL Documentation: Logical Replication. – PostgreSQL 16 Manual. – 2024. – URL: https://www.postgresql.org/docs/16/logical-replication.html

2. Spock Extension Documentation. Multi-Master Replication for PostgreSQL. – 2024. – URL: https://github.com/pgEdge/spock

3. Stonebraker M., Özsu M.T. Principles of Distributed Database Systems. – 4th ed. – Springer, 2020. – 685 c.

4. Docker Inc. Docker Compose Documentation. – 2024. – URL: https://docs.docker.com/compose/

5. PostgreSQL Global Development Group. PostgreSQL Documentation: Triggers. – PostgreSQL 16 Manual. – 2024. – URL: https://www.postgresql.org/docs/16/triggers.html

6. Fowler M. Patterns of Enterprise Application Architecture. – Addison-Wesley Professional, 2022. – 560 с.

7. ISO/IEC 9075-1:2023. Information technology – Database languages – SQL – Part 1: Framework. – Geneva: ISO, 2023.

---

# ПРИЛОЖЕНИЯ

## ПРИЛОЖЕНИЕ А - Скрипт инициализации системы

```bash
#!/bin/bash

CONTAINERS="central_db club1_db club2_db club3_db"

echo "============================================"
echo " Init data bases"
echo "============================================"

echo "============================================"
echo " STAGE 1: Creating schema and Spock nodes"
echo "============================================"

for C in $CONTAINERS; do
    echo "=== Setting up $C ==="
    docker exec $C bash -c "psql -U pgedge -d postgres -f /general/1_init.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /general/2_shema.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /general/3_triggers.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/1_sequences.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/2_publications.sql"
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/3_create_spok_node.sql"
done

echo ""
echo "=== Waiting for all nodes to be ready (10 seconds) ==="
sleep 10

echo ""
echo "============================================"
echo " STAGE 2: Creating subscriptions"
echo "============================================"

for C in $CONTAINERS; do
    echo "=== Creating subscriptions on $C ==="
    docker exec $C bash -c "psql -U admin -d computer_club_rdb -f /settings/4_create_subscriptions.sql"
done

echo ""
echo "============================================"
echo " Master-Master replication setup complete!"
echo "============================================"
```

## ПРИЛОЖЕНИЕ Б - Docker Compose конфигурация

```yaml
version: '3.8'

services:
  central_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: central_db
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - central_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/central/settings:/settings
      - ./distributed_db/central/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club1_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club1_db
    restart: unless-stopped
    ports:
      - "5433:5432"
    volumes:
      - club1_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_1/settings:/settings
      - ./distributed_db/club_1/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club2_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club2_db
    restart: unless-stopped
    ports:
      - "5434:5432"
    volumes:
      - club2_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_2/settings:/settings
      - ./distributed_db/club_2/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

  club3_db:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: club3_db
    restart: unless-stopped
    ports:
      - "5435:5432"
    volumes:
      - club3_data:/data/pgdata
      - ./distributed_db/general/:/general
      - ./distributed_db/club_3/settings:/settings
      - ./distributed_db/club_3/seed:/seed
      - ./tests:/tests
    networks:
      - club_net

volumes:
  central_data:
  club1_data:
  club2_data:
  club3_data:

networks:
  club_net:
    driver: bridge
```

## ПРИЛОЖЕНИЕ В - Пример тестового сценария

```sql
-- Тест master-master репликации для таблицы clients

-- На центре
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79991111111', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 1
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79992222222', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 2
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79993333333', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- На клубе 3
INSERT INTO clients (phone_number, discount_status, password_hash, registration_timestamp) 
VALUES ('79994444444', 1, '$2a$10$abcdefghijk1234567890lmnopqrstuv', NOW());

-- Проверка на каждом узле (должно быть 4 записи)
SELECT * FROM clients ORDER BY phone_number;
```

## ПРИЛОЖЕНИЕ Г - Журнал работ

| Этап работы | Дедлайн | Вес | Коленько | Ничик | Воронов |
|-------------|---------|-----|----------|-------|---------|
| Презентация | 16.12.2024 | 16 | 9 | 9 | 9 |
| Постановка задачи | 16.12.2024 | 18 | 9 | 9 | 9 |
| Определение структуры БД | 16.12.2024 | 27 | 10 | 9 | 8 |
| Загрузка данных | 16.12.2024 | 18 | 6 | 6 | 6 |
| Триггеры и процедуры | 16.12.2024 | 30 | 10 | 10 | 10 |
| Реализация репликации | 16.12.2024 | 30 | 10 | 10 | 10 |
| Тестирование | 16.12.2024 | 27 | 9 | 9 | 9 |
| Отчет | 16.12.2024 | 27 | 9 | 9 | 9 |
| **Итого** | | **193** | **72** | **71** | **70** |

---

**Конец документа**
